# Что такое нагрузочное тестирование, тестирование отказоустойчивости и стресс-тестирование? Что их отличает друг от друга?

**Нагрузочное тестирование** (Load Testing) или тестирование производительности (Performance Testing) — это автоматизированное тестирование, имитирующее работу определенного количества бизнес пользователей на каком-либо общем (разделяемом ими) ресурсе.

**Тестирование на отказоустойчивость** (Fault Tolerance Testing) — это процесс проверки надёжности и стабильности программного обеспечения при возникновении сбоев, ошибок или непредвиденных ситуаций. Цель данного вида тестирования — определить способность системы продолжать работу и восстанавливаться после возникновения проблем.

**Стресс-тестирование** — процесс тестирования программного или аппаратного обеспечения на стабильность в условиях высокой нагрузки. Определяются пределы выносливости системы, при которых она выходит из строя. Чаще всего это некое количество одновременных пользователей/запросов к серверу. После этого оценивают качество обработки системой такой ситуации.

*Отличия данных видов тестирования заключаются в их целях:*

| Тестирование на отказоустойчивость                                                                      | Нагрузочное тестирование                                         | Стресс-тестирование                                             |
| ------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | --------------------------------------------------------------- |
| Цель - определить способность системы продолжать работу и восстанавливаться после возникновения проблем | выявление пикового значения, при котором система начнёт тормозить | перегрузка ресурса до тех пор, пока сервер полностью «не ляжет» |
 
# Примеры выполнения каждого из трёх видов тестирования.

## 1. Пример нагрузочного тестирования "Битрикс24"

**Цели тестирования**

- смоделировать работу интернет-портала большой корпорации (100 тысяч сотрудников, большое количество демонстрационных данных);
- обеспечить методику тестирования, максимально близкую к поведению пользователей в реальной жизни;
- продемонстрировать стабильную работу портала без наличия ошибок в случае одновременной работы с порталом трети от всех сотрудников корпорации (не менее 30 тыс.) на доступном оборудовании;
- подтвердить эффективность технологии Веб-кластер в продукте 1С-Битрикс24: Enterprise;
- обеспечить уверенную одновременную работу примерно 1/3 из общего числа сотрудников и среднее время отклика портала в районе 1 секунды (для 95% запросов).

**Выделенное оборудование**

| Сервер      | Процессор                           | Оперативная память | Жёсткий диск                     |
| ----------- | ----------------------------------- | ------------------ | -------------------------------- |
| Базы данных | Intel Xeon W-2255 3.7 ГГц (10 ядер) | 128 ГБ DDR4        | 2 × 960 ГБ NVMe +2 × 8000 ГБ HDD |
| Приложений  | Intel Xeon E-2236 / 3.4 ГГц, 6 ядер | 32 ГБ DDR4         | 2 x 480 ГБ SSD                   |

**Программное обеспечение**

Программное обеспечение серверов было сконфигурировано с помощью продукта "1С-Битрикс: Виртуальная машина". Кластерное решение реализовано на основе технологии Веб-кластер.

**Параметры тестового интранет-портала:**

1. Типовое коробочное решение 1С-Битрикс24: Enterprise, версия 20.x.x с последними обновлениями, задействован модуль «Веб-кластер» для построения кластерного решения
1. Демонстрационный контент на момент старта финального теста: 590 тыс. сообщений в живой ленте, 540 тыс. комментариев, 40 тыс. новостей, 180 тыс. задач, 415 тыс. мгновенных сообщений
1. Количество сотрудников в базе данных портала на момент старта финального теста: 111 304 (распределены по 67 структурным подразделениям)

*Указанное количество пользователей за 1 час генерируют на тестовом портале:*

- 39 новостей
- 4 614 сообщений в ленте Новостей
- 4 685 комментариев
- 440 чатов
- 3 386 мгновенных сообщений
- 2 297 заданий бизнес-процессов
- 912 задач
- 367 документов
- 92 рабочие группы и проекта
- 291 встречу в календарях
- 2 385 уведомления

*За сутки (24 часа) на таком портале генерируются:*

- 936 новостей
- 110 736 сообщений в ленте Новостей
- 112 440 комментариев
- 10 560 чатов
- 81 264 мгновенных сообщения
- 55 128 заданий бизнес-процессов
- 21 888 задач
- 8 808 документов
- 2 208 рабочих групп и проектов
- 6 984 встречи в календарях
- 57 240 уведомлений

**Методика генерации нагрузки**

Нагрузка создавалась инструментом JMeter версии 5.3.3. Данные теста записывались в InfluxDB . Для визуализации аналитики использовали приложение Grafana. Мониторинг серверов осуществлялся при помощи системы мониторинга Zabbix.

Для тестирования было выбрано 29 сценариев из 13 блоков, свойственных для типового интранет-портала:

- авторизация,
- живая лента,
- поиск,
- чат (групповой и один на один),
- задачи,
- календарь,
- мой диск,
- новости,
- фотогалерея,
- сотрудники,
- профиль,
- бизнес-процессы,
- рабочие группы

Для каждого теста были подобраны веса, учитывающие работу различных пользователей на портале и долю каждого из блоков в общей нагрузке.

Была применена новая методика генерации нагрузки от пользователей. Вместо одного виртуального пользователя, перебирающего в случайном порядке типовые цепочки действий, нагрузка генерировалась большим количеством разных пользователей со своей учетной записью на портале. Генератор нагрузки авторизовывал каждого такого пользователя в системе, а затем выполнял под этим пользователем разнообразный набор сценариев. При этом между выполнением каждого нового сценария выполнялось ожидание (от 20 сек до 10 минут). Таким образом, эмулировалось максимально реальное поведение сотрудников предприятия, которые зашли в интранет-портал и работают с ним в течение дня.

**Результаты тестирования**

Демонстрационный портал, развернутый в кластерном решении из 5 серверов, обеспечил одновременную работу 30 тысяч пользователей, а это соответствует примерному профилю нагрузки для крупной корпорации, в которой работает 100 – 200 тысяч сотрудников.

## 2. Пример стресс-тестирования

Приложение CRM может принимать максимальную нагрузку пользователя в 50000 одновременно работающих пользователей. Предположим, что вы увеличиваете нагрузку до 51000 и выполняете некоторые транзакции, такие как обновление записей или добавление записи. Как только вы выполните транзакцию, приложение может синхронизироваться с системой базы данных. Таким образом, следующий тест должен выполняться при нагрузке пользователя 52000.

## 3. Пример тестирования отказоустойчивости

Для тестирования устойчивости необходимо проверить, как вся рабочая нагрузка ведёт себя в условиях периодических сбоев.

Выполните тестирования в среде разработки с использованием как синтетических, так и реальных пользовательских данных. Тестирование и разработка редко идентичны, поэтому важно проверять приложение в рабочей среде с помощью метода развертывания Blue-Green или раннего развертывания. Таким образом, вы тестируете приложение в реальных условиях, чтобы убедиться, что оно работает должным образом при полном развертывании.

План тестирования включает следующее:

- Хаотическая разработка
- Автоматизированное тестирование перед развертыванием
- Тестирование путем внедрения ошибок
- Тестирование пиковой нагрузки
- Тестирование аварийного восстановления



# Инструменты, с помощью которых можно провести нагрузочное тестирование базы данных

- Apache JMeter
- Taurus
- Locust
- Fiddler с BlackWidow и Watcher
- nGrinder
- The Grinder
- Gatling
- k6
- Tsung
- Siege
- Bees with Machine Guns
- Fortio
- Puppeteer
- Flood Element
- Artillery

# Способы оптимизации (улучшения производительности) базы данных

- **Индексация базы данных**
 
 При правильной индексации можно оптимизировать продолжительность выполнения запроса и повысить общую производительность базы данных. Индексы достигают этого, внедряя структуру данных, которая помогает поддерживать порядок и облегчает поиск информации; в основном, индексирование ускоряет процесс поиска данных и делает его более эффективным, тем самым экономя ваше время (и вашу систему) и усилия.

- **Оптимизация доступа к данным**

Использование кэша последовательностей и отдельных табличных пространств для больших таблиц может улучшить производительность системы. Кроме того, можно задать применимые размеры страниц и емкости хранения для этих табличным пространств и кэш-памяти для оптимальной производительности.
- **Изменение размеров кэшей последовательностей**

Последовательность - это объект базы данных, автоматически генерирующий уникальные значения ключей. Последовательность может генерировать одно значение за один раз или может генерировать кэш нескольких значений. Использование кэшей последовательностей улучшает производительность системы, потому что процессы могут получить значения из кэша, не ожидая последовательности для генерации отдельных значений.

- **Увеличение вычислительных мощностей сервера**

Чем лучше ваш процессор, тем быстрее и эффективнее будет ваша база данных. Поэтому, если ваша база данных работает не так, вы должны рассмотреть возможность обновления процессорного модуля более высокого класса; чем мощнее ваш процессор, тем меньше нагрузка при работе с несколькими приложениями и запросами.

- **Выделение большего числа памяти**

Подобно тому, как недостаточно мощный процессор может повлиять на эффективность базы данных, так же как и нехватка памяти. В конце концов, когда в базе данных недостаточно памяти для выполнения запрашиваемой работы, производительность базы данных по понятным причинам пойдет на спад. По сути, наличие большего объема памяти поможет повысить эффективность системы и общую производительность.

- **Дефрагментация данных**

Дефрагментация диска позволит сгруппировать соответствующие данные, поэтому операции, связанные с вводом/выводом, будут выполняться быстрее, что напрямую повлияет на общую производительность запросов и базы данных.

- **Типы дисков**

Для извлечения результатов даже одного запроса могут потребоваться миллионы операций ввода-вывода с диска, в зависимости от объема данных, к которым запрос должен получить доступ для обработки, и в зависимости от объема данных, возвращаемых из запроса. Таким образом, тип дисков на вашем сервере может сильно повлиять на производительность ваших SQL запросов. Работа с SSD-дисками может значительно повысить общую производительность базы данных и, в частности, производительность SQL-запросов.

- **Версия базы данных**

Другим важным фактором производительности базы данных является версия MySQL, которую вы в настоящее время развертываете. Обновление последней версии базы данных может существенно повлиять на общую производительность базы данных. Возможно, что один запрос может работать лучше в старых версиях MySQL, чем в новых, но если посмотреть на общую производительность, новые версии, как правило, работают лучше.
